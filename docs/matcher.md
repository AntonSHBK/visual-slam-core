# Feature Matchers

В SLAM и Visual Odometry качество сопоставления точек между изображениями определяет устойчивость всей системы. Ниже приведён обзор основных матчеров, используемых в `pyslam`, с пояснением, какие можно реализовать средствами **OpenCV**, а какие требуют **внешних библиотек и нейросетей**.

### 1. **LK — Lucas-Kanade Optical Flow (KLT-трекинг)**

* **Идея**: отслеживание уже найденных точек между кадрами по движению их интенсивности (градиентов).
* **Метод**: решает задачу минимизации разницы интенсивностей в окрестности точки с помощью итеративного поиска.
* **Особенности**:

  * Работает **без дескрипторов**, только по пиксельным патчам.
  * Хорошо подходит для последовательных кадров (малое смещение).
  * Не работает при сильных поворотах/масштабах.
* **Реализация в OpenCV**:
  `cv2.calcOpticalFlowPyrLK(img1, img2, pts1, None, **lk_params)`
* **Библиотеки**: только `cv2`.

### 2. **BF — Brute Force Matcher**

* **Идея**: прямое сравнение каждого дескриптора из первого изображения с каждым дескриптором из второго.
* **Метод**: выбирает ближайший по расстоянию дескриптор (Hamming для бинарных, L2 для float).
* **Особенности**:

  * Прост в реализации.
  * Медленный на большом числе фич.
  * Хорошо работает в паре с **ORB, BRISK, SIFT**.
* **Реализация в OpenCV**:
  `cv2.BFMatcher(normType, crossCheck).match(desc1, desc2)`
* **Библиотеки**: только `cv2`.

### 3. **FLANN — Fast Library for Approximate Nearest Neighbors**

* **Идея**: ускоренный поиск ближайших соседей через KD-дерево (float) или LSH (binary).
* **Метод**: строит индекс для дескрипторов и ищет кандидатов быстрее, чем полный перебор.
* **Особенности**:

  * Гораздо быстрее, чем BF, особенно при большом числе точек.
  * Используется чаще с **SIFT/SURF (float descriptors)**.
  * Есть приближения → возможны ошибки в матчах.
* **Реализация в OpenCV**:
  `cv2.FlannBasedMatcher(index_params, search_params).knnMatch(desc1, desc2, k=2)`
* **Библиотеки**: только `cv2`.

### 4. **XFEAT — Accelerated Features for Lightweight Image Matching**

* **Идея**: обученный нейросетевой детектор + дескриптор.
* **Особенности**:

  * Быстрее SuperPoint, предназначен для мобильных/встраиваемых систем.
  * Требует PyTorch и оригинальный код XFeat.
* **Реализация**: недоступна в чистом OpenCV.
* **Библиотеки**: `torch`, внешняя `XFeat`.

### 5. **LIGHTGLUE — Transformer-based Matching**

* **Идея**: использует трансформеры для сопоставления дескрипторов (обычно SuperPoint или SIFT).
* **Особенности**:

  * Находит более надёжные матчи, особенно в условиях слабо различимых текстур.
  * Применяется для robust matching.
* **Реализация**: нет в OpenCV, доступен как отдельная PyTorch-библиотека.
* **Библиотеки**: `torch`, `lightglue`.

### 6. **LOFTR — Local Feature TRansformer (Detector-Free Matching)**

* **Идея**: полностью детектор-free метод — сразу находит dense-соответствия между двумя изображениями.
* **Особенности**:

  * Не требует детектора/дескриптора (ORB/SIFT).
  * Особенно эффективен для текстурных и низкодетализированных областей.
  * Подходит для Structure-from-Motion и SLAM.
* **Реализация**: в `kornia.feature.LoFTR` (PyTorch).
* **Библиотеки**: `torch`, `kornia`.

### 7. **MAST3R — Grounded Matching in 3D**

* **Идея**: сопоставление изображений с учётом 3D-контекста (обучена на 3D-сценах).
* **Особенности**:

  * Работает в 3D-aware стиле, предсказывает дескрипторы, связанные с глубиной.
  * Самый тяжёлый по вычислениям.
* **Реализация**: через `dust3r` + PyTorch.
* **Библиотеки**: `torch`, `dust3r`.

## Итог

| Алгоритм  | Реализуем в OpenCV           | Нужны внешние библиотеки |
| --------- | ---------------------------- | ------------------------ |
| LK        | ✅ `cv2.calcOpticalFlowPyrLK` | –                        |
| BF        | ✅ `cv2.BFMatcher`            | –                        |
| FLANN     | ✅ `cv2.FlannBasedMatcher`    | –                        |
| XFEAT     | ❌                            | PyTorch + XFeat          |
| LIGHTGLUE | ❌                            | PyTorch + LightGlue      |
| LOFTR     | ❌                            | PyTorch + Kornia         |
| MAST3R    | ❌                            | PyTorch + Dust3r         |

