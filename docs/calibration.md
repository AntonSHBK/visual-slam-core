# MonoCalibration — суть и место в пайплайне

**MonoCalibration** описывает геометрию одной камеры и правила «исправления» её изображений, чтобы вычисления на них были корректны. Это фундамент для любых последующих шагов — детектирования признаков, оценки глубины из моно-моделей, визуальной одометрии и пр. В твоём пайплайне этот слой относится к этапу «захват и предобработка», где устраняются оптические искажения и приводятся кадры к согласованной геометрии перед расчётом глубины/3D и облака точек. Тем самым он задаёт качество входных данных для всего восприятия и планирования движения.

Что именно хранит и делает класс:

1. **Внутренняя калибровка (K)**
   Матрица камеры кодирует фокусные расстояния по осям и координаты главной точки. Она связывает пиксельные координаты с лучами в системе координат камеры. Любая геометрическая операция в CV/SLAM (проекция, обратная проекция, нормализация координат) опирается на K. В монокамере без дополнительных датчиков масштаб сцены остаётся неизвестным, но сама «форма» проективной геометрии фиксируется именно K.

2. **Модель дисторсии (dist, model)**
   Реальные линзы искажают изображение. Массив коэффициентов и тип модели (обычно «radtan/PlumbBob» или «fisheye») описывают это искажение. Устранение дисторсии повышает стабильность сопоставления признаков, точность измерений и качество любых карт глубины. Выбор корректной модели критичен: применение «fisheye» к обычной линзе или наоборот приводит к остаточным искажениям и деградации результатов.

3. **Размер исходного кадра (image\_size)**
   Геометрия привязана к разрешению. Карты коррекции и любые «новые» матрицы рассчитываются для конкретного размера кадра; несоответствие размеров вызывает смещения и артефакты по краям. Поэтому класс явно хранит размеры, чтобы генерировать корректные преобразования.

4. **Карты ремапа undistort (initUndistortRectifyMap → remap)**
   Вместо того чтобы каждый раз применять формулы на лету, заранее строятся «карты» переназначения пикселей. Это даёт два эффекта: предсказуемое время обработки и одинаковую геометрию для всех последующих модулей (трекинг, глубина, одометрия). Параметр **alpha** регулирует компромисс между сохранением поля зрения и обрезкой чёрных полей по краям. Для «fisheye» и «radtan» набор формул разный, класс скрывает эту разницу, обеспечивая единый интерфейс.

Практическая роль:

* Приводит кадры к «пинхол-модели» без искажений, что повышает качество сопоставления и устойчивость алгоритмов VO/SLAM.
* Делает результаты воспроизводимыми: все последующие оценки и карты строятся в согласованной плоскости изображения.
* Служит «контрактом» между сенсорным вводом и 3D-этапами пайплайна (глубина, облако точек, локальные карты).

# StereoCalibration — суть и место в пайплайне

**StereoCalibration** описывает пару жёстко закреплённых камер. В отличие от моно-случая, здесь важна не только каждая камера по отдельности, но и **взаимная поза** между ними. Эта информация позволяет получать **метрическую** глубину из диспаратности и проектировать каждую точку сцены в 3D без внешних масштабов. В твоём пайплайне класс лежит на критическом пути «получение глубины/3D» → «формирование облака точек», а затем «передача в планировщик».

Ключевые составляющие и действия:

1. **Внутренняя калибровка обеих камер (K1, D1, K2, D2)**
   Как и в моно-случае, каждая камера имеет свою K и дисторсию. Эти параметры необходимы для исправления искажений и согласования полей зрения левого и правого изображений перед стерео-сопоставлением. Качество и стабильность диспаратности напрямую зависят от точности этих величин.

2. **Внешняя калибровка (R, T)**
   Это ориентация и смещение правой камеры относительно левой. Вектор **T** (в метрах) и матрица поворота **R** фиксируют базис системы: именно **|T|** задаёт **базис** (baseline). Чем точнее R и T, тем корректнее «схлопывание» эпиполярной геометрии и тем стабильнее оценка глубины. Ошибки в R/T ведут к «плавающим» горизонтам и систематическим смещениям глубины.

3. **Ректификация (R1, R2, P1, P2)**
   Ректификация — это согласование изображений так, чтобы соответствующие точки лежали на одной строке (эпиполярные линии становятся горизонтальными). Матрицы **R1, R2** поворачивают плоскости изображений, а **P1, P2** задают эквивалентные проекционные модели для «виртуальных» прямолинейных камер после ректификации. На практике это резко упрощает соответствие (поиск диспаратности) и делает его более точным и быстрым.

4. **Матрица Q и переход к 3D**
   Матрица **Q** связана с геометрией пары (f, cx, cy, baseline) и позволяет преобразовать диспаратность в точки трёхмерного пространства: из «смещения между левым и правым пикселем» получается глубина Z и координаты X, Y. Q — мост между плотной диспаратностью и облаком точек; без корректной Q облако будет нестабильно по масштабу и форме.

5. **Карты ремапа для пары (лево/право)**
   По аналогии с моно-случаем, для каждого глаза строятся карты, которые переводят «сырые» кадры в общий ректифицированный вид. Это обеспечивает устойчивое, повторяемое и быстрое формирование входных данных для алгоритмов стерео-сопоставления (SGBM/BM/нейронные стерео-модели).

Практическая роль:

* Обеспечивает **метрическую** глубину в реальном времени из двух камер, минуя неоднозначность масштаба моно-подходов.
* Служит «геометрическим контрактом» для всего стерео-конвейера: от ректификации к диспаратности и далее к облаку точек и локальной карте.
* Непосредственно влияет на качество планирования: корректная глубина → чистое облако → стабильная классификация свободного/занятого пространства.
